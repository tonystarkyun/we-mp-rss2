# WeRSS 爬虫功能修复完整文档

## 概述

本文档详细记录了WeRSS项目中Playwright爬虫功能从失败到成功修复的完整过程，包括问题分析、解决方案和最终配置。

## 问题描述

### 初始问题
- **开发环境**：爬虫功能正常，能成功提取文章
- **打包环境**：爬虫功能失败，出现各种浏览器相关错误

### 典型错误信息
```
ERROR:core.crawler:爬取网站时发生错误: Page.goto: Target page, context or browser has been closed
```

```
BrowserType.launch: Executable doesn't exist at /tmp/_MEIxxxxx/playwright/driver/package/.local-browsers/chromium_headless_shell-1187/chrome-linux/headless_shell
```

## 根本原因分析

### 1. 路径配置冲突
多个运行时钩子文件同时设置 `PLAYWRIGHT_BROWSERS_PATH`，导致路径冲突：

- `runtime_hook.py`: 设置错误的 `ms-playwright` 路径
- `runtime_hook_playwright.py`: 设置不正确的浏览器路径
- `WeRSS-Linux.spec`: 浏览器目录映射不匹配

### 2. 浏览器选择问题
Chromium 在 Linux 打包环境中存在稳定性问题，而 Firefox 更适合打包环境。

### 3. 依赖打包不完整
某些修复尝试中注释掉了浏览器打包，导致文件大小从 615MB 降到 242MB，缺少必要的浏览器依赖。

## 解决方案详解

### 第一步：统一浏览器选择策略

**修改文件**: `core/crawler.py`

**关键更改**:
```python
# 之前：使用 Chromium（不稳定）
browser = await p.chromium.launch(headless=self.headless)

# 修复后：使用 Firefox（稳定）
browser = await p.firefox.launch(headless=self.headless)
```

**技术原理**:
- Firefox 在 Linux 打包环境中更稳定
- 与二维码功能使用的 Firefox 保持一致
- 减少浏览器类型带来的兼容性问题

### 第二步：正确配置 Runtime Hook

**修改文件**: `runtime_hook_playwright.py`

**核心配置**:
```python
def setup_browser_paths():
    if hasattr(sys, '_MEIPASS'):
        bundle_dir = sys._MEIPASS
        
        # 正确设置 Playwright 浏览器路径
        playwright_dir = os.path.join(bundle_dir, 'playwright')
        if os.path.exists(playwright_dir):
            os.environ['PLAYWRIGHT_BROWSERS_PATH'] = playwright_dir
            print(f"Runtime Hook: 设置 PLAYWRIGHT_BROWSERS_PATH = {playwright_dir}")
            
        # 设置 Firefox 路径
        firefox_path = os.path.join(playwright_dir, 'firefox-1490', 'firefox', 'firefox')
        if os.path.exists(firefox_path):
            os.environ['FIREFOX_BINARY'] = firefox_path
            print(f"Runtime Hook: 设置 FIREFOX_BINARY = {firefox_path}")
```

**关键点**:
- 路径验证：检查浏览器文件是否真实存在
- 调试输出：提供详细的路径设置日志
- 跨平台支持：Linux 和 Windows 路径分别处理

### 第三步：修复 PyInstaller 规格文件

**修改文件**: `WeRSS-Linux.spec`

**数据文件映射**:
```python
datas=[
    # 恢复完整的 Playwright 浏览器打包
    (os.path.expanduser('~/.cache/ms-playwright'), 'playwright') 
    if os.path.exists(os.path.expanduser('~/.cache/ms-playwright')) 
    else ('', ''),
    
    # Firefox 原生支持
    (os.path.expanduser('~/firefox-native/firefox'), 'firefox-native') 
    if os.path.exists(os.path.expanduser('~/firefox-native/firefox')) 
    else ('', ''),
]
```

### 第四步：清理冲突的配置

**修改文件**: `runtime_hook.py`

**问题修复**:
```python
# 注释掉错误的路径设置，避免冲突
# os.environ['PLAYWRIGHT_BROWSERS_PATH'] = playwright_browsers_path
print("Runtime Hook: 发现Playwright目录，让其自动选择浏览器")
```

## 最终工作配置

### 1. 文件大小验证
- **修复前**: ~242MB（依赖缺失）
- **修复后**: ~615MB（包含完整浏览器）

### 2. 运行时日志示例
```
Runtime Hook: 设置 PLAYWRIGHT_BROWSERS_PATH = /tmp/_MEIIKuIiz/playwright
Runtime Hook: 发现Chromium浏览器: /tmp/_MEIIKuIiz/playwright/chromium-1187/chrome-linux/chrome
Runtime Hook: 设置 FIREFOX_BINARY = /tmp/_MEIIKuIiz/playwright/firefox-1490/firefox/firefox
Runtime Hook: 浏览器路径设置完成
INFO:core.crawler:使用Firefox浏览器
INFO:core.crawler:正在爬取网站: https://scholar.google.com/scholar?hl=en&as_sdt=0%2C5&q=flaxseed&btnG=
INFO:core.crawler:共提取到 5 篇文章 ✅
```

### 3. 网络环境支持
- **无 VPN**: 能爬取不需要代理的网站
- **有 VPN**: 能爬取需要 VPN 的网站
- **自然代理行为**: Firefox 自动使用系统网络设置

## 核心技术决策

### 1. 浏览器选择: Chrome → Firefox
**原因**:
- Linux 打包环境兼容性更好
- 与现有二维码功能保持一致
- 减少不同浏览器引起的问题

### 2. 路径管理策略
**原则**:
- 单一真实来源：只在一个地方设置 `PLAYWRIGHT_BROWSERS_PATH`
- 验证优先：设置路径前验证文件存在
- 调试友好：提供详细的路径设置日志

### 3. 依赖打包策略
**方法**:
- 完整打包：包含 Playwright 完整浏览器目录
- 条件映射：根据构建环境动态包含依赖
- 备用方案：同时支持系统浏览器作为后备

## 修复验证清单

### ✅ 功能验证
- [ ] 开发环境爬虫正常工作
- [ ] 打包环境爬虫正常工作
- [ ] 不同网站类型都能正确提取文章
- [ ] 二维码功能仍然正常（Firefox 兼容性）

### ✅ 环境验证
- [ ] 无 VPN 环境下能访问普通网站
- [ ] 有 VPN 环境下能访问需要代理的网站
- [ ] 文件大小接近 615MB（包含完整依赖）

### ✅ 错误处理
- [ ] 网络错误有适当的重试机制
- [ ] 浏览器启动失败有清晰的错误信息
- [ ] 不同类型网站的解析都有容错处理

## 最终打包命令

```bash
# 清理之前的构建
rm -rf build/ dist/we-rss-linux

# 使用修复后的配置打包
pyinstaller WeRSS-Linux.spec --clean

# 验证文件大小（应该约为 615MB）
ls -lh dist/we-rss-linux

# 测试功能
./dist/we-rss-linux -init True
```

## 部署注意事项

### 1. 系统要求
- Linux x86_64
- 足够的磁盘空间（~1GB 用于临时解压）
- 网络访问权限

### 2. 运行环境
- 不需要预安装浏览器
- 不需要设置额外的环境变量
- 支持不同的网络配置（代理/无代理）

### 3. 故障排除
如果遇到问题，检查以下几点：

1. **文件大小**: 确保约为 615MB
2. **运行时日志**: 查看 `Runtime Hook` 输出
3. **浏览器路径**: 确认 Firefox 路径设置正确
4. **网络连接**: 验证目标网站可访问

## 技术架构总结

```
WeRSS 爬虫架构
├── PyInstaller 打包
│   ├── WeRSS-Linux.spec (数据文件映射)
│   ├── runtime_hook_playwright.py (路径设置)
│   └── runtime_hook.py (清理冲突)
├── 爬虫核心 (core/crawler.py)
│   ├── Firefox 浏览器启动
│   ├── 文章选择器策略
│   └── 错误处理机制
└── 浏览器依赖
    ├── Playwright Firefox (~/.cache/ms-playwright)
    ├── Native Firefox (~/firefox-native/firefox)
    └── 系统浏览器 (备用方案)
```

## 结论

通过系统性地分析和修复路径配置、浏览器选择和依赖打包问题，成功实现了开发环境和打包环境的爬虫功能统一。关键在于：

1. **统一浏览器选择**：使用稳定的 Firefox
2. **正确路径管理**：避免多处配置冲突
3. **完整依赖打包**：确保所有必要文件包含
4. **自然网络行为**：支持各种网络环境

这种解决方案确保了 WeRSS 项目在不同部署环境下的稳定性和可靠性。